var Y=["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"];var D=class{constructor(t,r,n,o=0){this.context=t,this.sampleUrl=r,this.index=o,this.buffer=null,this.setInitSequence(),this.setInitParams(),this.gainNode=t.createGain(),this.gainNode.connect(n)}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let r=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(r)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,r={}){let n={volume:r.volume??this.volume,filterFreq:r.filterFreq??this.filterFreq,filterType:r.filterType??this.filterType,filterQ:r.filterQ??this.filterQ};if(this.buffer){let o=this.context.createBufferSource();o.buffer=this.buffer;let a=this.context.createBiquadFilter();a.type=n.filterType||"lowpass",a.frequency.value=n.filterFreq,typeof n.filterQ=="number"&&(a.Q.value=n.filterQ);let s=this.context.createGain();s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(n.volume,t+.005),o.connect(a),a.connect(s),s.connect(this.gainNode),o.start(t)}else{let o=this.context.createOscillator(),a=200+this.index%8*60;o.type="square",o.frequency.setValueAtTime(a,t);let s=this.context.createBiquadFilter();s.type=n.filterType||"lowpass",s.frequency.setValueAtTime(n.filterFreq,t);try{typeof n.filterQ=="number"&&s.Q.setValueAtTime(n.filterQ,t)}catch(l){console.warn(`Filter Q setting failed: ${l.message}`)}let i=this.context.createGain();i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(n.volume,t+.02),i.gain.linearRampToValueAtTime(0,t+.18),o.connect(s),s.connect(i),i.connect(this.gainNode),o.start(t),o.stop(t+.2)}}setInitSequence(){this.sequence=new Array(16).fill(null).map(()=>({trig:!1,locks:{}}))}setInitParams(){this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.level=1,this.muted=!1,this.solo=!1}};var Se=window.AudioContext||window.webkitAudioContext,p=new Se,X=p.createGain();X.gain.setValueAtTime(1,p.currentTime);var $=p.createAnalyser();$.fftSize=2048;X.connect($);$.connect(p.destination);var Z=120;function xe(e=Z){return 1/(e/60*4)}var j=!1,V=0,G=0,Ae=.1,L=[];function qe(e,t){for(let r of L){let n=r.sequence[e];if(n?.trig){try{if(typeof document<"u"){let o={trackIndex:r.index,step:e,time:t};document.dispatchEvent(new CustomEvent("track-trigger",{detail:o}))}}catch(o){console.log(`Exception while doing something: ${o.message}`)}r.trigger(t,n.locks)}}}function ee(){if(!j)return;let e=p.currentTime;for(;G<e+Ae;)qe(V,G),G+=xe(),V=(V+1)%16;requestAnimationFrame(ee)}async function te(){p.state==="suspended"&&await p.resume(),j=!0,V=0,G=p.currentTime,ee()}function ne(){j=!1}async function oe(e){return L=e.map((t,r)=>new D(p,t,X,r)),await Promise.all(L.map(t=>t.load())),L}function U(){let e=L.some(r=>r.solo),t=p.currentTime;for(let r of L){let o=(e?r.solo:!r.muted)?1:0;try{r.gainNode.gain.cancelScheduledValues(t),r.gainNode.gain.setValueAtTime(r.level*o,t)}catch(a){console.log(`Exception while doing something: ${a.message}`)}}}function re(){return $}function K(e){Z=e}function J(){return Z}function P(){return L}var N=null,B=-1,u=0,H=null,M=null,h=null,O=null,R=null,z=new Map;typeof document<"u"&&document.addEventListener("track-trigger",e=>{try{let t=e?.detail?.trackIndex;typeof t=="number"&&we(t)}catch{}});function ae(e){N&&cancelAnimationFrame(N);function t(){Le(e),N=requestAnimationFrame(t)}N=requestAnimationFrame(t),ke()}function se(){N&&cancelAnimationFrame(N),N=null;for(let e of document.querySelectorAll(".step--playhead"))e.classList.remove("step--playhead");B=-1,Me()}function Ce(){if(M=document.getElementById("scope-canvas"),!M)return!1;let e=window.devicePixelRatio||1,t=M.getBoundingClientRect();if(M.width=Math.max(300,t.width*e),M.height=Math.max(120,t.height*e),h=M.getContext("2d"),h&&h.scale(e,e),O=re(),!O)return!1;let r=O.fftSize||2048;return R=new Uint8Array(r),!0}function ie(){if(!h||!O||!M||!R)return;let e=M.getBoundingClientRect(),t=e.width,r=e.height;O.getByteTimeDomainData(R),h.clearRect(0,0,t,r),h.fillStyle="rgba(0,0,0,0.02)",h.fillRect(0,0,t,r),h.lineWidth=2,h.strokeStyle="hsl(160 80% 60%)",h.beginPath();let n=R.length/t;for(let o=0;o<t;o++){let a=Math.floor(o*n),s=R[a]/128-1,i=r/2+s*(r/2)*.9;o===0?h.moveTo(o,i):h.lineTo(o,i)}h.stroke(),H=requestAnimationFrame(ie)}function ke(){H||Ce()&&ie()}function Me(){H&&cancelAnimationFrame(H),H=null}function Le(e){let t=e();if(t===null)return;let r=p.currentTime-t,n=1/(J()/60*4);if(n<=0)return;let a=(Math.floor(r/n)%16+16)%16;if(a===B)return;let s=document.querySelector(".track-display");if(s){if(B>=0)for(let i of s.querySelectorAll(`.step[data-step="${B}"]`))i.classList.remove("step--playhead");for(let i of s.querySelectorAll(`.step[data-step="${a}"]`))i.classList.add("step--playhead");B=a}}function I(e){let t=P()[e],r=document.querySelector(".track-display"),n=document.getElementById("track-info");if(!r)return;B=-1,r.innerHTML="";let o=document.createElement("div");o.className="track",o.innerHTML=`
    <h2>Track ${e+1}</h2>
  `;let a=document.createElement("div");a.className="steps";let i=`hsl(${Math.round(e*360/Math.max(1,8))} 75% 48%)`;a.style.setProperty("--track-accent",i);for(let l=0;l<16;l++){let c=document.createElement("button");c.className="step",c.dataset.step=String(l),t.sequence[l]?.trig&&c.classList.add("active"),c.addEventListener("click",()=>{t.sequence[l].trig=!t.sequence[l].trig,c.classList.toggle("active",t.sequence[l].trig)}),a.appendChild(c)}if(o.appendChild(a),r.appendChild(o),n){let l=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";n.innerHTML="";let c=document.createElement("span");c.className="meta",c.textContent=`Track ${e+1}`;let g=document.createElement("span");g.textContent=`Sample: ${l}`,n.appendChild(c),n.appendChild(g)}}function Ne(){let e=document.getElementById("mixer");if(!e)return;e.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',e.appendChild(t);let r=document.createElement("div");r.className="mixer-grid";for(let[n,o]of P().entries()){let a=document.createElement("div");a.className="channel",a.dataset.track=String(n);let i=`hsl(${Math.round(n*360/Math.max(1,8))} 75% 48%)`;a.style.setProperty("--channel-accent",i);let l=document.createElement("div");l.className="label",l.textContent=o.sampleUrl?o.sampleUrl.replace(/^.*\//,""):`Track ${n+1}`;let c=document.createElement("div");c.className="controls";let g=document.createElement("button");g.className="mute",g.title="Mute",g.textContent="M",g.addEventListener("click",y=>{y.stopPropagation(),o.muted=!o.muted,U(),q()});let T=document.createElement("button");T.className="solo",T.title="Solo",T.textContent="S",T.addEventListener("click",y=>{y.stopPropagation(),o.solo=!o.solo,U(),q()}),c.appendChild(g),c.appendChild(T);let w=document.createElement("div");w.className="fader-wrap";let f=document.createElement("input");f.type="range",f.min="0",f.max="1",f.step="0.01";let E=typeof o.level=="number"?o.level:o.gainNode?.gain?.value??1;f.value=String(E),f.title="Level",w.appendChild(f),f.addEventListener("input",()=>{let y=Number(f.value),x=p.currentTime;try{o.gainNode.gain.cancelScheduledValues(x),o.gainNode.gain.setValueAtTime(o.gainNode.gain.value,x);let F=P().some(S=>S.solo)?o.solo:!o.muted,_=y*(F?1:0);o.gainNode.gain.linearRampToValueAtTime(_,x+.03)}catch{try{o.gainNode.gain.setValueAtTime(y,x)}catch{}}o.level=y}),c.appendChild(w),a.appendChild(l),a.appendChild(c),a.addEventListener("click",y=>{let x=y.target;if(x&&(x.classList.contains("mute")||x.classList.contains("solo")))return;let b=document.querySelector(".track-screen");u===n&&b||(b&&b.classList.remove("collapsed"),u=n,I(u),Q(u),q())}),r.appendChild(a)}e.appendChild(r),q()}function we(e,t=160){let r=document.querySelector(`.mixer-grid .channel[data-track="${e}"]`);if(!r)return;let n=z.get(e);n&&(clearTimeout(n),z.delete(e)),r.classList.add("channel--hit");let o=setTimeout(()=>{r.classList.remove("channel--hit"),z.delete(e)},t);z.set(e,o)}function Q(e){let t=document.getElementById("filter");if(!t)return;let r=P()[e];t.innerHTML="";let n=20,o=2e4,a=.1,s=30,i=document.createElement("h3");i.textContent=`Filter \u2014 Track ${e+1}`,t.appendChild(i);let l=document.createElement("div");l.className="filter-note",l.textContent=r.sampleUrl?r.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(l);let c=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],g=document.createElement("div");g.className="filter-type-row";for(let[d,v]of c){let m=document.createElement("button");m.className="filter-type-btn",m.type="button",m.textContent=v,r.filterType===d&&m.classList.add("active"),m.addEventListener("click",()=>{r.filterType=d;for(let C of g.querySelectorAll(".filter-type-btn"))C.classList.toggle("active",C===m)}),g.appendChild(m)}t.appendChild(g);let T=document.createElement("div");T.className="filter-row";let w=document.createElement("span");w.textContent="Freq";let f=document.createElement("span");f.className="filter-value",f.textContent=`${Math.round(r.filterFreq||2e3)}Hz`;let E=document.createElement("input");E.type="range",E.min="0",E.max="1000",E.step="1";let y=d=>{let v=Math.log10(n),m=Math.log10(o);return(Math.log10(d)-v)/(m-v)*1e3},x=d=>{let v=Math.log10(n),m=Math.log10(o),C=d/1e3;return 10**(v+C*(m-v))};E.value=String(y(r.filterFreq||2e3)),E.className="control",E.addEventListener("input",()=>{let d=x(Number(E.value));r.filterFreq=d,f.textContent=`${Math.round(d)}Hz`}),T.appendChild(w),T.appendChild(f),T.appendChild(E),t.appendChild(T);let b=document.createElement("div");b.className="filter-row";let F=document.createElement("span");F.textContent="Res";let _=document.createElement("span");_.className="filter-value",_.textContent=(r.filterQ||1).toFixed(2);let S=document.createElement("input");S.type="range",S.min="0",S.max="1000",S.step="1";let ce=d=>{let v=Math.log10(a),m=Math.log10(s);return(Math.log10(d)-v)/(m-v)*1e3},ue=d=>{let v=Math.log10(a),m=Math.log10(s),C=d/1e3;return 10**(v+C*(m-v))};S.value=String(ce(r.filterQ||1)),S.className="control",S.addEventListener("input",()=>{let d=ue(Number(S.value));r.filterQ=d,_.textContent=d.toFixed(2)}),b.appendChild(F),b.appendChild(_),b.appendChild(S),t.appendChild(b)}function q(){let e=document.querySelector(".mixer-grid");if(e)for(let t of e.querySelectorAll(".channel")){let n=Number(t.dataset.track),o=P()[n],a=t.querySelector(".mute"),s=t.querySelector(".solo");a&&a.classList.toggle("active",!!o.muted),s&&s.classList.toggle("active",!!o.solo);let i=t.querySelector(".fader-wrap input");if(i){let l=typeof o.level=="number"?o.level:o.gainNode?.gain?.value??1;i.value=String(l)}t.classList.toggle("active",n===u)}}function le(e){let t=document.querySelector(".tracks");if(t){t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,I(u),Ne(),Q(u);let n=document.getElementById("prev-track"),o=document.getElementById("next-track");n&&n.addEventListener("click",()=>{u=(u-1+8)%8,I(u),q(),Q(u)}),o&&o.addEventListener("click",()=>{u=(u+1)%8,I(u),q(),Q(u)})}let r=document.getElementById("bpm");r&&(r.value=String(J()),r.addEventListener("input",()=>{K(Number(r.value))})),window.addEventListener("keydown",n=>{try{let o=n.target;if(o&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable))return;let a=n.key;if(!/^[1-9]$/.test(a))return;let s=Number(a)-1;if(s<0||s>=8)return;let i=document.querySelector(".track-screen");if(u===s){if(i)return}else i&&i.classList.remove("collapsed"),u=s,I(u),Q(u);q()}catch(o){console.warn("Keyboard handler error",o)}})}var W=null;async function _e(){let e=await oe([...Y]);K(120);for(let n of e)for(let o of n.sequence)o.trig=!1;for(let n of[0,3,7,10,12])e[0]?.sequence[n]&&(e[0].sequence[n].trig=!0);for(let n of[4,12])e[1]?.sequence[n]&&(e[1].sequence[n].trig=!0);for(let n=0;n<16;n+=2)e[2]?.sequence[n]&&(e[2].sequence[n].trig=!0);for(let n of[6,14])e[3]?.sequence[n]&&(e[3].sequence[n].trig=!0);for(let n of[4,12])e[4]?.sequence[n]&&(e[4].sequence[n].trig=!0);for(let n of[2,6,11,15])e[5]?.sequence[n]&&(e[5].sequence[n].trig=!0);for(let n of[8,14])e[6]?.sequence[n]&&(e[6].sequence[n].trig=!0);for(let n of[7,13])e[7]?.sequence[n]&&(e[7].sequence[n].trig=!0);e[0]&&(e[0].volume=1),e[1]&&(e[1].volume=.9),e[2]&&(e[2].volume=.55),e[3]&&(e[3].volume=.5),e[4]&&(e[4].volume=.6),e[5]&&(e[5].volume=.6),e[6]&&(e[6].volume=.5),e[7]&&(e[7].volume=.45),e[0]&&(e[0].filterFreq=1800),e[1]&&(e[1].filterFreq=2200),e[2]&&(e[2].filterFreq=7e3),le(()=>W);let t=document.getElementById("play-btn"),r=document.getElementById("stop-btn");t&&t.addEventListener("click",async()=>{await te(),W=p.currentTime,ae(()=>W)}),r&&r.addEventListener("click",()=>{ne(),W=null,se()}),U(),q(),console.log("App booted \u2014 press Play")}_e().catch(e=>console.error("Boot failed:",e));
