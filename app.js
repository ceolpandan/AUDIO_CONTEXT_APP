var E=new(globalThis.AudioContext||globalThis.webkitAudioContext),ae=E.createGain();ae.gain.setValueAtTime(1,E.currentTime);var Y=E.createAnalyser();Y.fftSize=2048;ae.connect(Y);Y.connect(E.destination);var ne=class{constructor(t,n,e=0){this.context=t,this.sampleUrl=n,this.index=e,this.buffer=null,this.pattern=new Array(16).fill(null).map(()=>({trig:!1,locks:{}})),this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.gainNode=t.createGain(),this.gainNode.connect(ae),this.level=1,this.gainNode.gain.setValueAtTime(this.level,this.context.currentTime),this.muted=!1,this.solo=!1}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(n)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,n={}){let e={volume:this.volume,filterFreq:this.filterFreq,...n};if(this.buffer){let o=this.context.createBufferSource();o.buffer=this.buffer;let i=this.context.createBiquadFilter();i.type=e.filterType||"lowpass",i.frequency.value=e.filterFreq,typeof e.filterQ=="number"&&(i.Q.value=e.filterQ);let c=this.context.createGain();c.gain.setValueAtTime(0,t),c.gain.linearRampToValueAtTime(e.volume,t+.005),o.connect(i),i.connect(c),c.connect(this.gainNode),o.start(t)}else{let o=this.context.createOscillator(),i=200+this.index%8*60;o.type="square",o.frequency.setValueAtTime(i,t);let c=this.context.createBiquadFilter();c.type=e.filterType||"lowpass",c.frequency.setValueAtTime(e.filterFreq,t);try{typeof e.filterQ=="number"&&c.Q.setValueAtTime(e.filterQ,t)}catch(h){console.warn(`Filter Q setting failed: ${h.message}`)}let d=this.context.createGain();d.gain.setValueAtTime(0,t),d.gain.linearRampToValueAtTime(e.volume,t+.02),d.gain.linearRampToValueAtTime(0,t+.18),o.connect(c),c.connect(d),d.connect(this.gainNode),o.start(t),o.stop(t+.2)}}},re=120;function De(r=re){return 1/(r/60*4)}var oe=!1,X=0,z=0,$e=.1,a=[];function He(r,t){a.forEach(n=>{let e=n.pattern[r];if(e?.trig){try{typeof document<"u"&&document.dispatchEvent(new CustomEvent("track-trigger",{detail:{trackIndex:n.index,step:r,time:t}}))}catch(o){console.log(`Exception while doing something: ${o.message}`)}n.trigger(t,e.locks)}})}function fe(){if(!oe)return;let r=E.currentTime;for(;z<r+$e;)He(X,z),z+=De(),X=(X+1)%16;requestAnimationFrame(fe)}async function he(){E.state==="suspended"&&await E.resume(),oe=!0,X=0,z=E.currentTime,fe()}function ge(){oe=!1}async function ve(r){return a=r.map((t,n)=>new ne(E,t,n)),await Promise.all(a.map(t=>t.load())),a}function Q(){let r=a.some(n=>n.solo),t=E.currentTime;a.forEach(n=>{let o=(r?n.solo:!n.muted)?1:0;try{n.gainNode.gain.cancelScheduledValues(t),n.gainNode.gain.setValueAtTime(n.level*o,t)}catch(i){console.log(`Exception while doing something: ${i.message}`)}})}function Ee(){return Y}function Z(r){re=r}function se(){return re}var P=null,B=-1,v=0,D=null,R=null,C=null,$=null,J=null,j=new Map;typeof document<"u"&&document.addEventListener("track-trigger",r=>{try{let t=r?.detail?.trackIndex;typeof t=="number"&&Ye(t)}catch{}});function ye(r){P&&cancelAnimationFrame(P);function t(){Xe(r),P=requestAnimationFrame(t)}P=requestAnimationFrame(t),Ge()}function Te(){P&&cancelAnimationFrame(P),P=null,document.querySelectorAll(".step--playhead").forEach(r=>r.classList.remove("step--playhead")),B=-1,We()}function Ke(){if(R=document.getElementById("scope-canvas"),!R)return!1;let r=window.devicePixelRatio||1,t=R.getBoundingClientRect();if(R.width=Math.max(300,t.width*r),R.height=Math.max(120,t.height*r),C=R.getContext("2d"),C.scale(r,r),$=Ee(),!$)return!1;let n=$.fftSize||2048;return J=new Uint8Array(n),!0}function Se(){if(!C||!$)return;let r=R.getBoundingClientRect(),t=r.width,n=r.height;$.getByteTimeDomainData(J),C.clearRect(0,0,t,n),C.fillStyle="rgba(0,0,0,0.02)",C.fillRect(0,0,t,n),C.lineWidth=2,C.strokeStyle="hsl(160 80% 60%)",C.beginPath();let e=J.length/t;for(let o=0;o<t;o++){let i=Math.floor(o*e),c=J[i]/128-1,d=n/2+c*(n/2)*.9;o===0?C.moveTo(o,d):C.lineTo(o,d)}C.stroke(),D=requestAnimationFrame(Se)}function Ge(){D||Ke()&&Se()}function We(){D&&cancelAnimationFrame(D),D=null}function Xe(r){let t=r();if(t===null)return;let n=E.currentTime-t,e=1/(se()/60*4);if(e<=0)return;let i=(Math.floor(n/e)%16+16)%16;if(i===B)return;let c=document.querySelector(".track-display");c&&(B>=0&&c.querySelectorAll(`.step[data-step="${B}"]`).forEach(d=>d.classList.remove("step--playhead")),c.querySelectorAll(`.step[data-step="${i}"]`).forEach(d=>d.classList.add("step--playhead")),B=i)}function O(r){let t=a[r],n=document.querySelector(".track-display"),e=document.getElementById("track-info");if(!n)return;B=-1,n.innerHTML="";let o=document.createElement("div");o.className="track",o.innerHTML=`
    <h2>Track ${r+1}</h2>
  `;let i=document.createElement("div");i.className="steps";let d=`hsl(${Math.round(r*360/Math.max(1,8))} 75% 48%)`;i.style.setProperty("--track-accent",d);for(let h=0;h<16;h++){let g=document.createElement("button");g.className="step",g.dataset.step=String(h),t.pattern[h]&&t.pattern[h].trig&&g.classList.add("active"),g.addEventListener("click",()=>{t.pattern[h].trig=!t.pattern[h].trig,g.classList.toggle("active",t.pattern[h].trig)}),i.appendChild(g)}if(o.appendChild(i),n.appendChild(o),e){let h=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";e.innerHTML="";let g=document.createElement("span");g.className="meta",g.textContent=`Track ${r+1}`;let l=document.createElement("span");l.textContent=`Sample: ${h}`,e.appendChild(g),e.appendChild(l)}}function ze(){let r=document.getElementById("mixer");if(!r)return;r.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',r.appendChild(t);let n=document.createElement("div");n.className="mixer-grid",a.forEach((e,o)=>{let i=document.createElement("div");i.className="channel",i.dataset.track=String(o);let d=`hsl(${Math.round(o*360/Math.max(1,8))} 75% 48%)`;i.style.setProperty("--channel-accent",d);let h=document.createElement("div");h.className="label",h.textContent=e.sampleUrl?e.sampleUrl.replace(/^.*\//,""):`Track ${o+1}`;let g=document.createElement("div");g.className="controls";let l=document.createElement("button");l.className="mute",l.title="Mute",l.textContent="M",l.addEventListener("click",f=>{f.stopPropagation(),e.muted=!e.muted,Q(),k()});let N=document.createElement("button");N.className="solo",N.title="Solo",N.textContent="S",N.addEventListener("click",f=>{f.stopPropagation(),e.solo=!e.solo,Q(),k()}),g.appendChild(l),g.appendChild(N);let x=document.createElement("div");x.className="fader-wrap";let T=document.createElement("input");T.type="range",T.min="0",T.max="1",T.step="0.01";let H=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;T.value=String(H),T.title="Level",x.appendChild(T),T.addEventListener("input",()=>{let f=Number(T.value),S=E.currentTime;try{e.gainNode.gain.cancelScheduledValues(S),e.gainNode.gain.setValueAtTime(e.gainNode.gain.value,S);let b=a.some(_=>_.solo)?e.solo:!e.muted,I=f*(b?1:0);e.gainNode.gain.linearRampToValueAtTime(I,S+.03)}catch{try{e.gainNode.gain.setValueAtTime(f,S)}catch{}}e.level=f}),g.appendChild(x),i.appendChild(h),i.appendChild(g),i.addEventListener("click",f=>{if(f.target&&(f.target.classList.contains("mute")||f.target.classList.contains("solo")))return;let S=document.querySelector(".track-screen");v===o&&S||(S&&S.classList.remove("collapsed"),v=o,O(v),V(v),k())}),n.appendChild(i)}),r.appendChild(n),k()}function Ye(r,t=160){let n=document.querySelector(`.mixer-grid .channel[data-track="${r}"]`);if(!n)return;let e=j.get(r);e&&(clearTimeout(e),j.delete(r)),n.classList.add("channel--hit");let o=setTimeout(()=>{n.classList.remove("channel--hit"),j.delete(r)},t);j.set(r,o)}function V(r){let t=document.getElementById("filter");if(!t)return;let n=a[r];t.innerHTML="";let e=20,o=12e3,i=.1,c=20,d=document.createElement("h3");d.textContent=`Filter \u2014 Track ${r+1}`,t.appendChild(d);let h=document.createElement("div");h.className="filter-note",h.textContent=n.sampleUrl?n.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(h);let g=document.createElement("div");g.className="filter-slope-wrap";let l=document.createElement("canvas");l.className="filter-slope",l.setAttribute("aria-label","Filter response"),g.appendChild(l),t.appendChild(g);let N=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],x=document.createElement("div");x.className="filter-type-row",N.forEach(([s,p])=>{let u=document.createElement("button");u.className="filter-type-btn",u.type="button",u.textContent=p,n.filterType===s&&u.classList.add("active"),u.addEventListener("click",()=>{n.filterType=s,x.querySelectorAll(".filter-type-btn").forEach(m=>m.classList.toggle("active",m===u)),q()}),x.appendChild(u)}),t.appendChild(x);let T=document.createElement("div");T.className="filter-row";let H=document.createElement("label");H.textContent="Freq";let f=document.createElement("input");f.type="range",f.min=String(e),f.max=String(o),f.step="1",f.value=String(n.filterFreq||2e3),f.className="control",f.addEventListener("input",()=>{n.filterFreq=Number(f.value),q()}),T.appendChild(H),T.appendChild(f),t.appendChild(T);let S=document.createElement("div");S.className="filter-row";let U=document.createElement("label");U.textContent="Res";let b=document.createElement("input");b.type="range",b.min=String(i),b.max=String(c),b.step="0.1",b.value=String(n.filterQ||1),b.className="control",b.addEventListener("input",()=>{n.filterQ=Number(b.value),q()}),S.appendChild(U),S.appendChild(b),t.appendChild(S);let I=document.createElement("div");I.className="filter-note",I.textContent="Drag the handle to change frequency (x) and resonance (y).",t.appendChild(I);let _=window.devicePixelRatio||1;function Ce(s){let u=l.getBoundingClientRect().width,m=e,w=o;return Math.log10(s/m)/Math.log10(w/m)*u}function ie(s){let u=l.getBoundingClientRect().width,m=Math.max(0,Math.min(1,s/u)),w=e;return w*Math.pow(o/w,m)}function ce(s){let u=l.getBoundingClientRect().height,m=1-Math.max(0,Math.min(1,s/u));return i*Math.pow(c/i,m)}function we(s){let u=l.getBoundingClientRect().height;return(1-Math.log(s/i)/Math.log(c/i))*u}function xe(s,p){let u=l.getBoundingClientRect(),m=u.width,w=u.height;s.clearRect(0,0,m,w),s.fillStyle="rgba(255,255,255,0.02)",s.fillRect(0,0,m,w);let A=256,G=new Float32Array(A),te=new Float32Array(A),Ae=new Float32Array(A),W=e,de=Math.min(o,E.sampleRate/2);for(let y=0;y<A;y++){let M=y/(A-1);G[y]=W*Math.pow(de/W,M)}try{let y=E.createBiquadFilter();y.type=p.filterType||"lowpass",y.frequency.value=p.filterFreq||2e3,y.Q.value=p.filterQ||1,y.getFrequencyResponse(G,te,Ae)}catch{for(let M=0;M<A;M++)te[M]=1}s.beginPath();for(let y=0;y<A;y++){let M=G[y],Fe=te[y],Ne=20*Math.log10(Math.max(1e-6,Fe)),ue=-60,pe=(1-(Ne-ue)/(12-ue))*w,me=Math.log10(M/W)/Math.log10(de/W)*m;y===0?s.moveTo(me,pe):s.lineTo(me,pe)}s.lineWidth=2,s.strokeStyle="hsl(200 80% 60%)",s.stroke();let Le=Ce(p.filterFreq||2e3),ke=we(p.filterQ||1);s.beginPath(),s.fillStyle="#fff",s.strokeStyle="rgba(0,0,0,0.6)",s.lineWidth=2,s.arc(Le,ke,6,0,Math.PI*2),s.fill(),s.stroke()}function q(){if(!l)return;let s=l.getContext("2d"),p=l.getBoundingClientRect();l.width=Math.max(300,p.width*_),l.height=Math.max(120,p.height*_),s.setTransform(_,0,0,_,0,0),xe(s,n),f.value=String(Math.round(n.filterFreq||2e3)),b.value=String(Number(n.filterQ||1).toFixed(1)),x.querySelectorAll(".filter-type-btn").forEach(m=>m.classList.toggle("active",m.textContent===function(){return{lowpass:"LP",highpass:"HP",bandpass:"BP",notch:"NT",allpass:"AP",peaking:"PK"}[n.filterType]||""}()))}let K=!1;function le(s){let p=l.getBoundingClientRect(),u=s.clientX-p.left,m=s.clientY-p.top;return{x:u,y:m}}l.addEventListener("pointerdown",s=>{s.preventDefault(),l.setPointerCapture(s.pointerId),K=!0;let p=le(s),u=ie(p.x),m=ce(p.y);n.filterFreq=u,n.filterQ=m,q()}),l.addEventListener("pointermove",s=>{if(!K)return;let p=le(s),u=ie(p.x),m=ce(p.y);n.filterFreq=u,n.filterQ=m,q()}),l.addEventListener("pointerup",s=>{if(K){K=!1;try{l.releasePointerCapture(s.pointerId)}catch{}}}),new ResizeObserver(()=>q()).observe(l),q()}function k(){let r=document.querySelector(".mixer-grid");r&&r.querySelectorAll(".channel").forEach(t=>{let n=Number(t.dataset.track),e=a[n],o=t.querySelector(".mute"),i=t.querySelector(".solo");o&&o.classList.toggle("active",!!e.muted),i&&i.classList.toggle("active",!!e.solo);let c=t.querySelector(".fader-wrap input");if(c){let d=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;c.value=String(d)}t.classList.toggle("active",n===v)})}function be(r){let t=document.querySelector(".tracks");t&&(t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,O(v),ze(),V(v),document.getElementById("prev-track").addEventListener("click",()=>{v=(v-1+8)%8,O(v),k(),V(v)}),document.getElementById("next-track").addEventListener("click",()=>{v=(v+1)%8,O(v),k(),V(v)}));let n=document.getElementById("bpm");n&&(n.value=se(),n.addEventListener("input",()=>{Z(Number(n.value))})),window.addEventListener("keydown",e=>{try{let o=e.target;if(o&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable))return;let i=e.key;if(!/^[1-9]$/.test(i))return;let c=Number(i)-1;if(c<0||c>=8)return;let d=document.querySelector(".track-screen");if(v===c){if(d)return}else d&&d.classList.remove("collapsed"),v=c,O(v),V(v);k()}catch(o){console.warn("Keyboard handler error",o)}})}var ee=null;async function Ze(){if(await ve(["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"]),Z(95),a&&a.length>0){a.forEach(e=>e.pattern.forEach(o=>o.trig=!1)),[0,3,7,10,12].forEach(e=>{a[0]&&a[0].pattern[e]&&(a[0].pattern[e].trig=!0)}),[4,12].forEach(e=>{a[1]&&a[1].pattern[e]&&(a[1].pattern[e].trig=!0)});for(let e=0;e<16;e+=2)a[2]&&a[2].pattern[e]&&(a[2].pattern[e].trig=!0);[6,14].forEach(e=>{a[3]&&a[3].pattern[e]&&(a[3].pattern[e].trig=!0)}),[4,12].forEach(e=>{a[4]&&a[4].pattern[e]&&(a[4].pattern[e].trig=!0)}),[2,6,11,15].forEach(e=>{a[5]&&a[5].pattern[e]&&(a[5].pattern[e].trig=!0)}),[8,14].forEach(e=>{a[6]&&a[6].pattern[e]&&(a[6].pattern[e].trig=!0)}),[7,13].forEach(e=>{a[7]&&a[7].pattern[e]&&(a[7].pattern[e].trig=!0)}),a[0]&&(a[0].volume=1),a[1]&&(a[1].volume=.9),a[2]&&(a[2].volume=.55),a[3]&&(a[3].volume=.5),a[4]&&(a[4].volume=.6),a[5]&&(a[5].volume=.6),a[6]&&(a[6].volume=.5),a[7]&&(a[7].volume=.45),a[0]&&(a[0].filterFreq=1800),a[1]&&(a[1].filterFreq=2200),a[2]&&(a[2].filterFreq=7e3)}be(()=>ee);let t=document.getElementById("play-btn"),n=document.getElementById("stop-btn");t&&t.addEventListener("click",async()=>{await he(),ee=E.currentTime,ye(()=>ee)}),n&&n.addEventListener("click",()=>{ge(),ee=null,Te()}),Q(),k(),console.log("App booted \u2014 press Play")}Ze().catch(r=>console.error("Boot failed:",r));
