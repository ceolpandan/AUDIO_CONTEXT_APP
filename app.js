var J=["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"];var O=class{constructor(t,e,a,n=0){this.context=t,this.sampleUrl=e,this.index=n,this.buffer=null,this.pattern=new Array(16).fill(null).map(()=>({trig:!1,locks:{}})),this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.gainNode=t.createGain(),this.gainNode.connect(a),this.level=1,this.gainNode.gain.setValueAtTime(this.level,this.context.currentTime),this.muted=!1,this.solo=!1}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let e=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(e)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,e={}){let a={volume:e.volume??this.volume,filterFreq:e.filterFreq??this.filterFreq,filterType:e.filterType??this.filterType,filterQ:e.filterQ??this.filterQ};if(this.buffer){let n=this.context.createBufferSource();n.buffer=this.buffer;let s=this.context.createBiquadFilter();s.type=a.filterType||"lowpass",s.frequency.value=a.filterFreq,typeof a.filterQ=="number"&&(s.Q.value=a.filterQ);let i=this.context.createGain();i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(a.volume,t+.005),n.connect(s),s.connect(i),i.connect(this.gainNode),n.start(t)}else{let n=this.context.createOscillator(),s=200+this.index%8*60;n.type="square",n.frequency.setValueAtTime(s,t);let i=this.context.createBiquadFilter();i.type=a.filterType||"lowpass",i.frequency.setValueAtTime(a.filterFreq,t);try{typeof a.filterQ=="number"&&i.Q.setValueAtTime(a.filterQ,t)}catch(c){console.warn(`Filter Q setting failed: ${c.message}`)}let l=this.context.createGain();l.gain.setValueAtTime(0,t),l.gain.linearRampToValueAtTime(a.volume,t+.02),l.gain.linearRampToValueAtTime(0,t+.18),n.connect(i),i.connect(l),l.connect(this.gainNode),n.start(t),n.stop(t+.2)}}};var be=window.AudioContext||window.webkitAudioContext,f=new be,W=f.createGain();W.gain.setValueAtTime(1,f.currentTime);var G=f.createAnalyser();G.fftSize=2048;W.connect(G);G.connect(f.destination);var X=120;function Se(r=X){return 1/(r/60*4)}var Z=!1,V=0,D=0,xe=.1,o=[];function Ae(r,t){for(let e of o){let a=e.pattern[r];if(!a?.trig)return;try{if(typeof document<"u"){let n={trackIndex:e.index,step:r,time:t};document.dispatchEvent(new CustomEvent("track-trigger",{detail:n}))}}catch(n){console.log(`Exception while doing something: ${n.message}`)}e.trigger(t,a.locks)}}function Y(){if(!Z)return;let r=f.currentTime;for(;D<r+xe;)Ae(V,D),D+=Se(),V=(V+1)%16;requestAnimationFrame(Y)}async function ee(){f.state==="suspended"&&await f.resume(),Z=!0,V=0,D=f.currentTime,Y()}function te(){Z=!1}async function ne(r){return o=r.map((t,e)=>new O(f,t,W,e)),await Promise.all(o.map(t=>t.load())),o}function B(){let r=o.some(e=>e.solo),t=f.currentTime;for(let e of o){let n=(r?e.solo:!e.muted)?1:0;try{e.gainNode.gain.cancelScheduledValues(t),e.gainNode.gain.setValueAtTime(e.level*n,t)}catch(s){console.log(`Exception while doing something: ${s.message}`)}}}function re(){return G}function $(r){X=r}function j(){return X}var w=null,P=-1,d=0,Q=null,N=null,T=null,H=null,U=null,K=new Map;typeof document<"u"&&document.addEventListener("track-trigger",r=>{try{let t=r?.detail?.trackIndex;typeof t=="number"&&we(t)}catch{}});function oe(r){w&&cancelAnimationFrame(w);function t(){Le(r),w=requestAnimationFrame(t)}w=requestAnimationFrame(t),ke()}function ae(){w&&cancelAnimationFrame(w),w=null;for(let r of document.querySelectorAll(".step--playhead"))r.classList.remove("step--playhead");P=-1,Me()}function Ce(){if(N=document.getElementById("scope-canvas"),!N)return!1;let r=window.devicePixelRatio||1,t=N.getBoundingClientRect();if(N.width=Math.max(300,t.width*r),N.height=Math.max(120,t.height*r),T=N.getContext("2d"),T&&T.scale(r,r),H=re(),!H)return!1;let e=H.fftSize||2048;return U=new Uint8Array(e),!0}function se(){if(!T||!H||!N||!U)return;let r=N.getBoundingClientRect(),t=r.width,e=r.height;H.getByteTimeDomainData(U),T.clearRect(0,0,t,e),T.fillStyle="rgba(0,0,0,0.02)",T.fillRect(0,0,t,e),T.lineWidth=2,T.strokeStyle="hsl(160 80% 60%)",T.beginPath();let a=U.length/t;for(let n=0;n<t;n++){let s=Math.floor(n*a),i=U[s]/128-1,l=e/2+i*(e/2)*.9;n===0?T.moveTo(n,l):T.lineTo(n,l)}T.stroke(),Q=requestAnimationFrame(se)}function ke(){Q||Ce()&&se()}function Me(){Q&&cancelAnimationFrame(Q),Q=null}function Le(r){let t=r();if(t===null)return;let e=f.currentTime-t,a=1/(j()/60*4);if(a<=0)return;let s=(Math.floor(e/a)%16+16)%16;if(s===P)return;let i=document.querySelector(".track-display");if(i){if(P>=0)for(let l of i.querySelectorAll(`.step[data-step="${P}"]`))l.classList.remove("step--playhead");for(let l of i.querySelectorAll(`.step[data-step="${s}"]`))l.classList.add("step--playhead");P=s}}function R(r){let t=o[r],e=document.querySelector(".track-display"),a=document.getElementById("track-info");if(!e)return;P=-1,e.innerHTML="";let n=document.createElement("div");n.className="track",n.innerHTML=`
    <h2>Track ${r+1}</h2>
  `;let s=document.createElement("div");s.className="steps";let l=`hsl(${Math.round(r*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--track-accent",l);for(let c=0;c<16;c++){let u=document.createElement("button");u.className="step",u.dataset.step=String(c),t.pattern[c]?.trig&&u.classList.add("active"),u.addEventListener("click",()=>{t.pattern[c].trig=!t.pattern[c].trig,u.classList.toggle("active",t.pattern[c].trig)}),s.appendChild(u)}if(n.appendChild(s),e.appendChild(n),a){let c=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";a.innerHTML="";let u=document.createElement("span");u.className="meta",u.textContent=`Track ${r+1}`;let v=document.createElement("span");v.textContent=`Sample: ${c}`,a.appendChild(u),a.appendChild(v)}}function Ne(){let r=document.getElementById("mixer");if(!r)return;r.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',r.appendChild(t);let e=document.createElement("div");e.className="mixer-grid";for(let[a,n]of o.entries()){let s=document.createElement("div");s.className="channel",s.dataset.track=String(a);let l=`hsl(${Math.round(a*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--channel-accent",l);let c=document.createElement("div");c.className="label",c.textContent=n.sampleUrl?n.sampleUrl.replace(/^.*\//,""):`Track ${a+1}`;let u=document.createElement("div");u.className="controls";let v=document.createElement("button");v.className="mute",v.title="Mute",v.textContent="M",v.addEventListener("click",b=>{b.stopPropagation(),n.muted=!n.muted,B(),k()});let E=document.createElement("button");E.className="solo",E.title="Solo",E.textContent="S",E.addEventListener("click",b=>{b.stopPropagation(),n.solo=!n.solo,B(),k()}),u.appendChild(v),u.appendChild(E);let F=document.createElement("div");F.className="fader-wrap";let g=document.createElement("input");g.type="range",g.min="0",g.max="1",g.step="0.01";let y=typeof n.level=="number"?n.level:n.gainNode?.gain?.value??1;g.value=String(y),g.title="Level",F.appendChild(g),g.addEventListener("input",()=>{let b=Number(g.value),A=f.currentTime;try{n.gainNode.gain.cancelScheduledValues(A),n.gainNode.gain.setValueAtTime(n.gainNode.gain.value,A);let q=o.some(x=>x.solo)?n.solo:!n.muted,_=b*(q?1:0);n.gainNode.gain.linearRampToValueAtTime(_,A+.03)}catch{try{n.gainNode.gain.setValueAtTime(b,A)}catch{}}n.level=b}),u.appendChild(F),s.appendChild(c),s.appendChild(u),s.addEventListener("click",b=>{let A=b.target;if(A&&(A.classList.contains("mute")||A.classList.contains("solo")))return;let S=document.querySelector(".track-screen");d===a&&S||(S&&S.classList.remove("collapsed"),d=a,R(d),I(d),k())}),e.appendChild(s)}r.appendChild(e),k()}function we(r,t=160){let e=document.querySelector(`.mixer-grid .channel[data-track="${r}"]`);if(!e)return;let a=K.get(r);a&&(clearTimeout(a),K.delete(r)),e.classList.add("channel--hit");let n=setTimeout(()=>{e.classList.remove("channel--hit"),K.delete(r)},t);K.set(r,n)}function I(r){let t=document.getElementById("filter");if(!t)return;let e=o[r];t.innerHTML="";let a=20,n=2e4,s=.1,i=30,l=document.createElement("h3");l.textContent=`Filter \u2014 Track ${r+1}`,t.appendChild(l);let c=document.createElement("div");c.className="filter-note",c.textContent=e.sampleUrl?e.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(c);let u=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],v=document.createElement("div");v.className="filter-type-row";for(let[m,h]of u){let p=document.createElement("button");p.className="filter-type-btn",p.type="button",p.textContent=h,e.filterType===m&&p.classList.add("active"),p.addEventListener("click",()=>{e.filterType=m;for(let M of v.querySelectorAll(".filter-type-btn"))M.classList.toggle("active",M===p)}),v.appendChild(p)}t.appendChild(v);let E=document.createElement("div");E.className="filter-row";let F=document.createElement("span");F.textContent="Freq";let g=document.createElement("span");g.className="filter-value",g.textContent=`${Math.round(e.filterFreq||2e3)}Hz`;let y=document.createElement("input");y.type="range",y.min="0",y.max="1000",y.step="1";let b=m=>{let h=Math.log10(a),p=Math.log10(n);return(Math.log10(m)-h)/(p-h)*1e3},A=m=>{let h=Math.log10(a),p=Math.log10(n),M=m/1e3;return 10**(h+M*(p-h))};y.value=String(b(e.filterFreq||2e3)),y.className="control",y.addEventListener("input",()=>{let m=A(Number(y.value));e.filterFreq=m,g.textContent=`${Math.round(m)}Hz`}),E.appendChild(F),E.appendChild(g),E.appendChild(y),t.appendChild(E);let S=document.createElement("div");S.className="filter-row";let q=document.createElement("span");q.textContent="Res";let _=document.createElement("span");_.className="filter-value",_.textContent=(e.filterQ||1).toFixed(2);let x=document.createElement("input");x.type="range",x.min="0",x.max="1000",x.step="1";let le=m=>{let h=Math.log10(s),p=Math.log10(i);return(Math.log10(m)-h)/(p-h)*1e3},ce=m=>{let h=Math.log10(s),p=Math.log10(i),M=m/1e3;return 10**(h+M*(p-h))};x.value=String(le(e.filterQ||1)),x.className="control",x.addEventListener("input",()=>{let m=ce(Number(x.value));e.filterQ=m,_.textContent=m.toFixed(2)}),S.appendChild(q),S.appendChild(_),S.appendChild(x),t.appendChild(S)}function k(){let r=document.querySelector(".mixer-grid");if(r)for(let t of r.querySelectorAll(".channel")){let a=Number(t.dataset.track),n=o[a],s=t.querySelector(".mute"),i=t.querySelector(".solo");s&&s.classList.toggle("active",!!n.muted),i&&i.classList.toggle("active",!!n.solo);let l=t.querySelector(".fader-wrap input");if(l){let c=typeof n.level=="number"?n.level:n.gainNode?.gain?.value??1;l.value=String(c)}t.classList.toggle("active",a===d)}}function ie(r){let t=document.querySelector(".tracks");if(t){t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,R(d),Ne(),I(d);let a=document.getElementById("prev-track"),n=document.getElementById("next-track");a&&a.addEventListener("click",()=>{d=(d-1+8)%8,R(d),k(),I(d)}),n&&n.addEventListener("click",()=>{d=(d+1)%8,R(d),k(),I(d)})}let e=document.getElementById("bpm");e&&(e.value=String(j()),e.addEventListener("input",()=>{$(Number(e.value))})),window.addEventListener("keydown",a=>{try{let n=a.target;if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.isContentEditable))return;let s=a.key;if(!/^[1-9]$/.test(s))return;let i=Number(s)-1;if(i<0||i>=8)return;let l=document.querySelector(".track-screen");if(d===i){if(l)return}else l&&l.classList.remove("collapsed"),d=i,R(d),I(d);k()}catch(n){console.warn("Keyboard handler error",n)}})}var z=null;async function qe(){if(await ne([...J]),$(120),o&&o.length>0){for(let e of o)for(let a of e.pattern)a.trig=!1;for(let e of[0,3,7,10,12])o[0]?.pattern[e]&&(o[0].pattern[e].trig=!0);for(let e of[4,12])o[1]?.pattern[e]&&(o[1].pattern[e].trig=!0);for(let e=0;e<16;e+=2)o[2]?.pattern[e]&&(o[2].pattern[e].trig=!0);for(let e of[6,14])o[3]?.pattern[e]&&(o[3].pattern[e].trig=!0);for(let e of[4,12])o[4]?.pattern[e]&&(o[4].pattern[e].trig=!0);for(let e of[2,6,11,15])o[5]?.pattern[e]&&(o[5].pattern[e].trig=!0);for(let e of[8,14])o[6]?.pattern[e]&&(o[6].pattern[e].trig=!0);for(let e of[7,13])o[7]?.pattern[e]&&(o[7].pattern[e].trig=!0);o[0]&&(o[0].volume=1),o[1]&&(o[1].volume=.9),o[2]&&(o[2].volume=.55),o[3]&&(o[3].volume=.5),o[4]&&(o[4].volume=.6),o[5]&&(o[5].volume=.6),o[6]&&(o[6].volume=.5),o[7]&&(o[7].volume=.45),o[0]&&(o[0].filterFreq=1800),o[1]&&(o[1].filterFreq=2200),o[2]&&(o[2].filterFreq=7e3)}ie(()=>z);let r=document.getElementById("play-btn"),t=document.getElementById("stop-btn");r&&r.addEventListener("click",async()=>{await ee(),z=f.currentTime,oe(()=>z)}),t&&t.addEventListener("click",()=>{te(),z=null,ae()}),B(),k(),console.log("App booted \u2014 press Play")}qe().catch(r=>console.error("Boot failed:",r));
