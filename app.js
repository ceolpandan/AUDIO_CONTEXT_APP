var f=new(globalThis.AudioContext||globalThis.webkitAudioContext),W=f.createGain();W.gain.setValueAtTime(1,f.currentTime);var D=f.createAnalyser();D.fftSize=2048;W.connect(D);D.connect(f.destination);var z=class{constructor(t,n,e=0){this.context=t,this.sampleUrl=n,this.index=e,this.buffer=null,this.pattern=new Array(16).fill(null).map(()=>({trig:!1,locks:{}})),this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.gainNode=t.createGain(),this.gainNode.connect(W),this.level=1,this.gainNode.gain.setValueAtTime(this.level,this.context.currentTime),this.muted=!1,this.solo=!1}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(n)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,n={}){let e={volume:this.volume,filterFreq:this.filterFreq,filterType:this.filterType,filterQ:this.filterQ,...n};if(this.buffer){let r=this.context.createBufferSource();r.buffer=this.buffer;let s=this.context.createBiquadFilter();s.type=e.filterType||"lowpass",s.frequency.value=e.filterFreq,typeof e.filterQ=="number"&&(s.Q.value=e.filterQ);let c=this.context.createGain();c.gain.setValueAtTime(0,t),c.gain.linearRampToValueAtTime(e.volume,t+.005),r.connect(s),s.connect(c),c.connect(this.gainNode),r.start(t)}else{let r=this.context.createOscillator(),s=200+this.index%8*60;r.type="square",r.frequency.setValueAtTime(s,t);let c=this.context.createBiquadFilter();c.type=e.filterType||"lowpass",c.frequency.setValueAtTime(e.filterFreq,t);try{typeof e.filterQ=="number"&&c.Q.setValueAtTime(e.filterQ,t)}catch(l){console.warn(`Filter Q setting failed: ${l.message}`)}let i=this.context.createGain();i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(e.volume,t+.02),i.gain.linearRampToValueAtTime(0,t+.18),r.connect(c),c.connect(i),i.connect(this.gainNode),r.start(t),r.stop(t+.2)}}},X=120;function ye(a=X){return 1/(a/60*4)}var Z=!1,O=0,V=0,Se=.1,o=[];function xe(a,t){o.forEach(n=>{let e=n.pattern[a];if(e?.trig){try{typeof document<"u"&&document.dispatchEvent(new CustomEvent("track-trigger",{detail:{trackIndex:n.index,step:a,time:t}}))}catch(r){console.log(`Exception while doing something: ${r.message}`)}n.trigger(t,e.locks)}})}function J(){if(!Z)return;let a=f.currentTime;for(;V<a+Se;)xe(O,V),V+=ye(),O=(O+1)%16;requestAnimationFrame(J)}async function Y(){f.state==="suspended"&&await f.resume(),Z=!0,O=0,V=f.currentTime,J()}function ee(){Z=!1}async function te(a){return o=a.map((t,n)=>new z(f,t,n)),await Promise.all(o.map(t=>t.load())),o}function U(){let a=o.some(n=>n.solo),t=f.currentTime;o.forEach(n=>{let r=(a?n.solo:!n.muted)?1:0;try{n.gainNode.gain.cancelScheduledValues(t),n.gainNode.gain.setValueAtTime(n.level*r,t)}catch(s){console.log(`Exception while doing something: ${s.message}`)}})}function ne(){return D}function $(a){X=a}function j(){return X}var M=null,q=-1,d=0,Q=null,N=null,T=null,I=null,G=null,H=new Map;typeof document<"u"&&document.addEventListener("track-trigger",a=>{try{let t=a?.detail?.trackIndex;typeof t=="number"&&we(t)}catch{}});function ae(a){M&&cancelAnimationFrame(M);function t(){ke(a),M=requestAnimationFrame(t)}M=requestAnimationFrame(t),Ce()}function oe(){M&&cancelAnimationFrame(M),M=null,document.querySelectorAll(".step--playhead").forEach(a=>a.classList.remove("step--playhead")),q=-1,be()}function Ae(){if(N=document.getElementById("scope-canvas"),!N)return!1;let a=window.devicePixelRatio||1,t=N.getBoundingClientRect();if(N.width=Math.max(300,t.width*a),N.height=Math.max(120,t.height*a),T=N.getContext("2d"),T.scale(a,a),I=ne(),!I)return!1;let n=I.fftSize||2048;return G=new Uint8Array(n),!0}function re(){if(!T||!I)return;let a=N.getBoundingClientRect(),t=a.width,n=a.height;I.getByteTimeDomainData(G),T.clearRect(0,0,t,n),T.fillStyle="rgba(0,0,0,0.02)",T.fillRect(0,0,t,n),T.lineWidth=2,T.strokeStyle="hsl(160 80% 60%)",T.beginPath();let e=G.length/t;for(let r=0;r<t;r++){let s=Math.floor(r*e),c=G[s]/128-1,i=n/2+c*(n/2)*.9;r===0?T.moveTo(r,i):T.lineTo(r,i)}T.stroke(),Q=requestAnimationFrame(re)}function Ce(){Q||Ae()&&re()}function be(){Q&&cancelAnimationFrame(Q),Q=null}function ke(a){let t=a();if(t===null)return;let n=f.currentTime-t,e=1/(j()/60*4);if(e<=0)return;let s=(Math.floor(n/e)%16+16)%16;if(s===q)return;let c=document.querySelector(".track-display");c&&(q>=0&&c.querySelectorAll(`.step[data-step="${q}"]`).forEach(i=>i.classList.remove("step--playhead")),c.querySelectorAll(`.step[data-step="${s}"]`).forEach(i=>i.classList.add("step--playhead")),q=s)}function B(a){let t=o[a],n=document.querySelector(".track-display"),e=document.getElementById("track-info");if(!n)return;q=-1,n.innerHTML="";let r=document.createElement("div");r.className="track",r.innerHTML=`
    <h2>Track ${a+1}</h2>
  `;let s=document.createElement("div");s.className="steps";let i=`hsl(${Math.round(a*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--track-accent",i);for(let l=0;l<16;l++){let u=document.createElement("button");u.className="step",u.dataset.step=String(l),t.pattern[l]?.trig&&u.classList.add("active"),u.addEventListener("click",()=>{t.pattern[l].trig=!t.pattern[l].trig,u.classList.toggle("active",t.pattern[l].trig)}),s.appendChild(u)}if(r.appendChild(s),n.appendChild(r),e){let l=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";e.innerHTML="";let u=document.createElement("span");u.className="meta",u.textContent=`Track ${a+1}`;let g=document.createElement("span");g.textContent=`Sample: ${l}`,e.appendChild(u),e.appendChild(g)}}function Le(){let a=document.getElementById("mixer");if(!a)return;a.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',a.appendChild(t);let n=document.createElement("div");n.className="mixer-grid",o.forEach((e,r)=>{let s=document.createElement("div");s.className="channel",s.dataset.track=String(r);let i=`hsl(${Math.round(r*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--channel-accent",i);let l=document.createElement("div");l.className="label",l.textContent=e.sampleUrl?e.sampleUrl.replace(/^.*\//,""):`Track ${r+1}`;let u=document.createElement("div");u.className="controls";let g=document.createElement("button");g.className="mute",g.title="Mute",g.textContent="M",g.addEventListener("click",E=>{E.stopPropagation(),e.muted=!e.muted,U(),b()});let y=document.createElement("button");y.className="solo",y.title="Solo",y.textContent="S",y.addEventListener("click",E=>{E.stopPropagation(),e.solo=!e.solo,U(),b()}),u.appendChild(g),u.appendChild(y);let F=document.createElement("div");F.className="fader-wrap";let h=document.createElement("input");h.type="range",h.min="0",h.max="1",h.step="0.01";let S=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;h.value=String(S),h.title="Level",F.appendChild(h),h.addEventListener("input",()=>{let E=Number(h.value),A=f.currentTime;try{e.gainNode.gain.cancelScheduledValues(A),e.gainNode.gain.setValueAtTime(e.gainNode.gain.value,A);let R=o.some(x=>x.solo)?e.solo:!e.muted,_=E*(R?1:0);e.gainNode.gain.linearRampToValueAtTime(_,A+.03)}catch{try{e.gainNode.gain.setValueAtTime(E,A)}catch{}}e.level=E}),u.appendChild(F),s.appendChild(l),s.appendChild(u),s.addEventListener("click",E=>{if(E.target&&(E.target.classList.contains("mute")||E.target.classList.contains("solo")))return;let A=document.querySelector(".track-screen");d===r&&A||(A&&A.classList.remove("collapsed"),d=r,B(d),P(d),b())}),n.appendChild(s)}),a.appendChild(n),b()}function we(a,t=160){let n=document.querySelector(`.mixer-grid .channel[data-track="${a}"]`);if(!n)return;let e=H.get(a);e&&(clearTimeout(e),H.delete(a)),n.classList.add("channel--hit");let r=setTimeout(()=>{n.classList.remove("channel--hit"),H.delete(a)},t);H.set(a,r)}function P(a){let t=document.getElementById("filter");if(!t)return;let n=o[a];t.innerHTML="";let e=20,r=2e4,s=.1,c=30,i=document.createElement("h3");i.textContent=`Filter \u2014 Track ${a+1}`,t.appendChild(i);let l=document.createElement("div");l.className="filter-note",l.textContent=n.sampleUrl?n.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(l);let u=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],g=document.createElement("div");g.className="filter-type-row",u.forEach(([p,v])=>{let m=document.createElement("button");m.className="filter-type-btn",m.type="button",m.textContent=v,n.filterType===p&&m.classList.add("active"),m.addEventListener("click",()=>{n.filterType=p,g.querySelectorAll(".filter-type-btn").forEach(L=>L.classList.toggle("active",L===m))}),g.appendChild(m)}),t.appendChild(g);let y=document.createElement("div");y.className="filter-row";let F=document.createElement("span");F.textContent="Freq";let h=document.createElement("span");h.className="filter-value",h.textContent=`${Math.round(n.filterFreq||2e3)}Hz`;let S=document.createElement("input");S.type="range",S.min="0",S.max="1000",S.step="1";let E=p=>{let v=Math.log10(e),m=Math.log10(r);return(Math.log10(p)-v)/(m-v)*1e3},A=p=>{let v=Math.log10(e),m=Math.log10(r),L=p/1e3;return 10**(v+L*(m-v))};S.value=String(E(n.filterFreq||2e3)),S.className="control",S.addEventListener("input",()=>{let p=A(Number(S.value));n.filterFreq=p,h.textContent=`${Math.round(p)}Hz`}),y.appendChild(F),y.appendChild(h),y.appendChild(S),t.appendChild(y);let k=document.createElement("div");k.className="filter-row";let R=document.createElement("span");R.textContent="Res";let _=document.createElement("span");_.className="filter-value",_.textContent=(n.filterQ||1).toFixed(2);let x=document.createElement("input");x.type="range",x.min="0",x.max="1000",x.step="1";let ce=p=>{let v=Math.log10(s),m=Math.log10(c);return(Math.log10(p)-v)/(m-v)*1e3},ie=p=>{let v=Math.log10(s),m=Math.log10(c),L=p/1e3;return 10**(v+L*(m-v))};x.value=String(ce(n.filterQ||1)),x.className="control",x.addEventListener("input",()=>{let p=ie(Number(x.value));n.filterQ=p,_.textContent=p.toFixed(2)}),k.appendChild(R),k.appendChild(_),k.appendChild(x),t.appendChild(k)}function b(){let a=document.querySelector(".mixer-grid");a&&a.querySelectorAll(".channel").forEach(t=>{let n=Number(t.dataset.track),e=o[n],r=t.querySelector(".mute"),s=t.querySelector(".solo");r&&r.classList.toggle("active",!!e.muted),s&&s.classList.toggle("active",!!e.solo);let c=t.querySelector(".fader-wrap input");if(c){let i=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;c.value=String(i)}t.classList.toggle("active",n===d)})}function se(a){let t=document.querySelector(".tracks");t&&(t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,B(d),Le(),P(d),document.getElementById("prev-track").addEventListener("click",()=>{d=(d-1+8)%8,B(d),b(),P(d)}),document.getElementById("next-track").addEventListener("click",()=>{d=(d+1)%8,B(d),b(),P(d)}));let n=document.getElementById("bpm");n&&(n.value=j(),n.addEventListener("input",()=>{$(Number(n.value))})),window.addEventListener("keydown",e=>{try{let r=e.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable))return;let s=e.key;if(!/^[1-9]$/.test(s))return;let c=Number(s)-1;if(c<0||c>=8)return;let i=document.querySelector(".track-screen");if(d===c){if(i)return}else i&&i.classList.remove("collapsed"),d=c,B(d),P(d);b()}catch(r){console.warn("Keyboard handler error",r)}})}var K=null;async function Ne(){if(await te(["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"]),$(95),o&&o.length>0){o.forEach(e=>e.pattern.forEach(r=>r.trig=!1)),[0,3,7,10,12].forEach(e=>{o[0]?.pattern[e]&&(o[0].pattern[e].trig=!0)}),[4,12].forEach(e=>{o[1]?.pattern[e]&&(o[1].pattern[e].trig=!0)});for(let e=0;e<16;e+=2)o[2]?.pattern[e]&&(o[2].pattern[e].trig=!0);[6,14].forEach(e=>{o[3]?.pattern[e]&&(o[3].pattern[e].trig=!0)}),[4,12].forEach(e=>{o[4]?.pattern[e]&&(o[4].pattern[e].trig=!0)}),[2,6,11,15].forEach(e=>{o[5]?.pattern[e]&&(o[5].pattern[e].trig=!0)}),[8,14].forEach(e=>{o[6]?.pattern[e]&&(o[6].pattern[e].trig=!0)}),[7,13].forEach(e=>{o[7]?.pattern[e]&&(o[7].pattern[e].trig=!0)}),o[0]&&(o[0].volume=1),o[1]&&(o[1].volume=.9),o[2]&&(o[2].volume=.55),o[3]&&(o[3].volume=.5),o[4]&&(o[4].volume=.6),o[5]&&(o[5].volume=.6),o[6]&&(o[6].volume=.5),o[7]&&(o[7].volume=.45),o[0]&&(o[0].filterFreq=1800),o[1]&&(o[1].filterFreq=2200),o[2]&&(o[2].filterFreq=7e3)}se(()=>K);let t=document.getElementById("play-btn"),n=document.getElementById("stop-btn");t&&t.addEventListener("click",async()=>{await Y(),K=f.currentTime,ae(()=>K)}),n&&n.addEventListener("click",()=>{ee(),K=null,oe()}),U(),b(),console.log("App booted \u2014 press Play")}Ne().catch(a=>console.error("Boot failed:",a));
