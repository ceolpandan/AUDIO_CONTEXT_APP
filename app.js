var v=new(window.AudioContext||window.webkitAudioContext),ae=v.createGain();ae.gain.setValueAtTime(1,v.currentTime);var Y=v.createAnalyser();Y.fftSize=2048;ae.connect(Y);Y.connect(v.destination);var ne=class{constructor(t,n,e=0){this.context=t,this.sampleUrl=n,this.index=e,this.buffer=null,this.pattern=Array(16).fill(null).map(()=>({trig:!1,locks:{}})),this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.gainNode=t.createGain(),this.gainNode.connect(ae),this.level=1,this.gainNode.gain.setValueAtTime(this.level,this.context.currentTime),this.muted=!1,this.solo=!1}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(n)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,n={}){let e={volume:this.volume,filterFreq:this.filterFreq,...n};if(this.buffer){let o=this.context.createBufferSource();o.buffer=this.buffer;let s=this.context.createBiquadFilter();s.type=e.filterType||"lowpass",s.frequency.value=e.filterFreq,typeof e.filterQ=="number"&&(s.Q.value=e.filterQ);let c=this.context.createGain();c.gain.setValueAtTime(0,t),c.gain.linearRampToValueAtTime(e.volume,t+.005),o.connect(s),s.connect(c),c.connect(this.gainNode),o.start(t)}else{let o=this.context.createOscillator(),s=200+this.index%8*60;o.type="square",o.frequency.setValueAtTime(s,t);let c=this.context.createBiquadFilter();c.type=e.filterType||"lowpass",c.frequency.setValueAtTime(e.filterFreq,t);try{typeof e.filterQ=="number"&&c.Q.setValueAtTime(e.filterQ,t)}catch{}let d=this.context.createGain();d.gain.setValueAtTime(0,t),d.gain.linearRampToValueAtTime(e.volume,t+.02),d.gain.linearRampToValueAtTime(0,t+.18),o.connect(c),c.connect(d),d.connect(this.gainNode),o.start(t),o.stop(t+.2)}}},re=120;function Ie(r=re){return 1/(r/60*4)}var oe=!1,z=0,X=0,Qe=.1,a=[];function _e(r,t){a.forEach(n=>{let e=n.pattern[r];if(!(!e||!e.trig)){try{typeof document<"u"&&document.dispatchEvent(new CustomEvent("track-trigger",{detail:{trackIndex:n.index,step:r,time:t}}))}catch{}n.trigger(t,e.locks)}})}function fe(){if(!oe)return;let r=v.currentTime;for(;X<r+Qe;)_e(z,X),X+=Ie(),z=(z+1)%16;requestAnimationFrame(fe)}var Ve=0;async function he(){v.state==="suspended"&&await v.resume(),oe=!0,z=0,X=v.currentTime,Ve=v.currentTime,fe()}function ge(){oe=!1}async function ve(r){return a=r.map((t,n)=>new ne(v,t,n)),await Promise.all(a.map(t=>t.load())),a}function _(){let r=a.some(n=>n.solo),t=v.currentTime;a.forEach(n=>{let o=(r?n.solo:!n.muted)?1:0;try{n.gainNode.gain.cancelScheduledValues(t),n.gainNode.gain.setValueAtTime(n.level*o,t)}catch{}})}function ye(){return Y}function Z(r){re=r}function ie(){return re}var B=null,U=-1,g=0,$=null,P=null,S=null,H=null,J=null,j=new Map;typeof document<"u"&&document.addEventListener("track-trigger",r=>{try{let t=r?.detail?.trackIndex;typeof t=="number"&&Ke(t)}catch{}});function Ee(r){B&&cancelAnimationFrame(B);function t(){Oe(r),B=requestAnimationFrame(t)}B=requestAnimationFrame(t),$e()}function Te(){B&&cancelAnimationFrame(B),B=null,document.querySelectorAll(".step--playhead").forEach(r=>r.classList.remove("step--playhead")),U=-1,He()}function De(){if(P=document.getElementById("scope-canvas"),!P)return!1;let r=window.devicePixelRatio||1,t=P.getBoundingClientRect();if(P.width=Math.max(300,t.width*r),P.height=Math.max(120,t.height*r),S=P.getContext("2d"),S.scale(r,r),H=ye(),!H)return!1;let n=H.fftSize||2048;return J=new Uint8Array(n),!0}function be(){if(!S||!H)return;let r=P.getBoundingClientRect(),t=r.width,n=r.height;H.getByteTimeDomainData(J),S.clearRect(0,0,t,n),S.fillStyle="rgba(0,0,0,0.02)",S.fillRect(0,0,t,n),S.lineWidth=2,S.strokeStyle="hsl(160 80% 60%)",S.beginPath();let e=J.length/t;for(let o=0;o<t;o++){let s=Math.floor(o*e),c=J[s]/128-1,d=n/2+c*(n/2)*.9;o===0?S.moveTo(o,d):S.lineTo(o,d)}S.stroke(),$=requestAnimationFrame(be)}function $e(){$||De()&&be()}function He(){$&&cancelAnimationFrame($),$=null}function Oe(r){let t=r();if(t==null)return;let n=v.currentTime-t,e=1/(ie()/60*4);if(e<=0)return;let s=(Math.floor(n/e)%16+16)%16;if(s===U)return;let c=document.querySelector(".track-display");c&&(U>=0&&c.querySelectorAll(`.step[data-step="${U}"]`).forEach(d=>d.classList.remove("step--playhead")),c.querySelectorAll(`.step[data-step="${s}"]`).forEach(d=>d.classList.add("step--playhead")),U=s)}function V(r){let t=a[r],n=document.querySelector(".track-display"),e=document.getElementById("track-info");if(!n)return;U=-1,n.innerHTML="";let o=document.createElement("div");o.className="track",o.innerHTML=`
    <h2>Track ${r+1}</h2>
  `;let s=document.createElement("div");s.className="steps";let d=`hsl(${Math.round(r*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--track-accent",d);for(let h=0;h<16;h++){let y=document.createElement("button");y.className="step",y.dataset.step=String(h),t.pattern[h]&&t.pattern[h].trig&&y.classList.add("active"),y.addEventListener("click",()=>{t.pattern[h].trig=!t.pattern[h].trig,y.classList.toggle("active",t.pattern[h].trig)}),s.appendChild(y)}if(o.appendChild(s),n.appendChild(o),e){let h=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";e.innerHTML=`<span class="meta">Track ${r+1}</span><span>Sample: ${h}</span>`}}function Ge(){let r=document.getElementById("mixer");if(!r)return;r.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',r.appendChild(t);let n=document.createElement("div");n.className="mixer-grid",a.forEach((e,o)=>{let s=document.createElement("div");s.className="channel",s.dataset.track=String(o);let d=`hsl(${Math.round(o*360/Math.max(1,8))} 75% 48%)`;s.style.setProperty("--channel-accent",d);let h=document.createElement("div");h.className="label",h.textContent=e.sampleUrl?e.sampleUrl.replace(/^.*\//,""):`Track ${o+1}`;let y=document.createElement("div");y.className="controls";let l=document.createElement("button");l.className="mute",l.title="Mute",l.textContent="M",l.addEventListener("click",f=>{f.stopPropagation(),e.muted=!e.muted,_(),q()});let F=document.createElement("button");F.className="solo",F.title="Solo",F.textContent="S",F.addEventListener("click",f=>{f.stopPropagation(),e.solo=!e.solo,_(),q()}),y.appendChild(l),y.appendChild(F);let A=document.createElement("div");A.className="fader-wrap";let T=document.createElement("input");T.type="range",T.min="0",T.max="1",T.step="0.01";let O=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;T.value=String(O),T.title="Level",A.appendChild(T),T.addEventListener("input",()=>{let f=Number(T.value),b=v.currentTime;try{e.gainNode.gain.cancelScheduledValues(b),e.gainNode.gain.setValueAtTime(e.gainNode.gain.value,b);let w=a.some(x=>x.solo)?e.solo:!e.muted,Q=f*(w?1:0);e.gainNode.gain.linearRampToValueAtTime(Q,b+.03)}catch{try{e.gainNode.gain.setValueAtTime(f,b)}catch{}}e.level=f}),y.appendChild(A),s.appendChild(h),s.appendChild(y),s.addEventListener("click",f=>{if(f.target&&(f.target.classList.contains("mute")||f.target.classList.contains("solo")))return;let b=document.querySelector(".track-screen");g===o&&b?b.classList.toggle("collapsed"):(b&&b.classList.remove("collapsed"),g=o,V(g),D(g)),q()}),n.appendChild(s)}),r.appendChild(n),q()}function Ke(r,t=160){let n=document.querySelector(`.mixer-grid .channel[data-track="${r}"]`);if(!n)return;let e=j.get(r);e&&(clearTimeout(e),j.delete(r)),n.classList.add("channel--hit");let o=setTimeout(()=>{n.classList.remove("channel--hit"),j.delete(r)},t);j.set(r,o)}function D(r){let t=document.getElementById("filter");if(!t)return;let n=a[r];t.innerHTML="";let e=20,o=12e3,s=.1,c=20,d=document.createElement("h3");d.textContent=`Filter \u2014 Track ${r+1}`,t.appendChild(d);let h=document.createElement("div");h.className="filter-note",h.textContent=n.sampleUrl?n.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(h);let y=document.createElement("div");y.className="filter-slope-wrap";let l=document.createElement("canvas");l.className="filter-slope",l.setAttribute("aria-label","Filter response"),y.appendChild(l),t.appendChild(y);let F=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],A=document.createElement("div");A.className="filter-type-row",F.forEach(([i,p])=>{let u=document.createElement("button");u.className="filter-type-btn",u.type="button",u.textContent=p,n.filterType===i&&u.classList.add("active"),u.addEventListener("click",()=>{n.filterType=i,A.querySelectorAll(".filter-type-btn").forEach(m=>m.classList.toggle("active",m===u)),N()}),A.appendChild(u)}),t.appendChild(A);let T=document.createElement("div");T.className="filter-row";let O=document.createElement("label");O.textContent="Freq";let f=document.createElement("input");f.type="range",f.min=String(e),f.max=String(o),f.step="1",f.value=String(n.filterFreq||2e3),f.className="control",f.addEventListener("input",()=>{n.filterFreq=Number(f.value),N()}),T.appendChild(O),T.appendChild(f),t.appendChild(T);let b=document.createElement("div");b.className="filter-row";let I=document.createElement("label");I.textContent="Res";let w=document.createElement("input");w.type="range",w.min=String(s),w.max=String(c),w.step="0.1",w.value=String(n.filterQ||1),w.className="control",w.addEventListener("input",()=>{n.filterQ=Number(w.value),N()}),b.appendChild(I),b.appendChild(w),t.appendChild(b);let Q=document.createElement("div");Q.className="filter-note",Q.textContent="Drag the handle to change frequency (x) and resonance (y).",t.appendChild(Q);let x=window.devicePixelRatio||1;function ze(){let i=l.getBoundingClientRect();l.width=Math.max(300,i.width*x),l.height=Math.max(120,i.height*x),l.getContext("2d").scale(x,x)}function Se(i){let u=l.getBoundingClientRect().width,m=e,C=o;return Math.log10(i/m)/Math.log10(C/m)*u}function se(i){let u=l.getBoundingClientRect().width,m=Math.max(0,Math.min(1,i/u)),C=e;return C*Math.pow(o/C,m)}function ce(i){let u=l.getBoundingClientRect().height,m=1-Math.max(0,Math.min(1,i/u));return s*Math.pow(c/s,m)}function xe(i){let u=l.getBoundingClientRect().height;return(1-Math.log(i/s)/Math.log(c/s))*u}function Ce(i,p){let u=l.getBoundingClientRect(),m=u.width,C=u.height;i.clearRect(0,0,m,C),i.fillStyle="rgba(255,255,255,0.02)",i.fillRect(0,0,m,C);let L=256,K=new Float32Array(L),te=new Float32Array(L),Ae=new Float32Array(L),W=e,de=Math.min(o,v.sampleRate/2);for(let E=0;E<L;E++){let M=E/(L-1);K[E]=W*Math.pow(de/W,M)}try{let E=v.createBiquadFilter();E.type=p.filterType||"lowpass",E.frequency.value=p.filterFreq||2e3,E.Q.value=p.filterQ||1,E.getFrequencyResponse(K,te,Ae)}catch{for(let M=0;M<L;M++)te[M]=1}i.beginPath();for(let E=0;E<L;E++){let M=K[E],qe=te[E],Fe=20*Math.log10(Math.max(1e-6,qe)),ue=-60,pe=(1-(Fe-ue)/(12-ue))*C,me=Math.log10(M/W)/Math.log10(de/W)*m;E===0?i.moveTo(me,pe):i.lineTo(me,pe)}i.lineWidth=2,i.strokeStyle="hsl(200 80% 60%)",i.stroke();let Le=Se(p.filterFreq||2e3),ke=xe(p.filterQ||1);i.beginPath(),i.fillStyle="#fff",i.strokeStyle="rgba(0,0,0,0.6)",i.lineWidth=2,i.arc(Le,ke,6,0,Math.PI*2),i.fill(),i.stroke()}function N(){if(!l)return;let i=l.getContext("2d"),p=l.getBoundingClientRect();l.width=Math.max(300,p.width*x),l.height=Math.max(120,p.height*x),i.setTransform(x,0,0,x,0,0),Ce(i,n),f.value=String(Math.round(n.filterFreq||2e3)),w.value=String(Number(n.filterQ||1).toFixed(1)),A.querySelectorAll(".filter-type-btn").forEach(m=>m.classList.toggle("active",m.textContent===function(){return{lowpass:"LP",highpass:"HP",bandpass:"BP",notch:"NT",allpass:"AP",peaking:"PK"}[n.filterType]||""}()))}let G=!1;function le(i){let p=l.getBoundingClientRect(),u=i.clientX-p.left,m=i.clientY-p.top;return{x:u,y:m}}l.addEventListener("pointerdown",i=>{i.preventDefault(),l.setPointerCapture(i.pointerId),G=!0;let p=le(i),u=se(p.x),m=ce(p.y);n.filterFreq=u,n.filterQ=m,N()}),l.addEventListener("pointermove",i=>{if(!G)return;let p=le(i),u=se(p.x),m=ce(p.y);n.filterFreq=u,n.filterQ=m,N()}),l.addEventListener("pointerup",i=>{if(G){G=!1;try{l.releasePointerCapture(i.pointerId)}catch{}}}),new ResizeObserver(()=>N()).observe(l),N()}function q(){let r=document.querySelector(".mixer-grid");r&&r.querySelectorAll(".channel").forEach(t=>{let n=Number(t.dataset.track),e=a[n],o=t.querySelector(".mute"),s=t.querySelector(".solo");o&&o.classList.toggle("active",!!e.muted),s&&s.classList.toggle("active",!!e.solo);let c=t.querySelector(".fader-wrap input");if(c){let d=typeof e.level=="number"?e.level:e.gainNode?.gain?.value??1;c.value=String(d)}t.classList.toggle("active",n===g)})}function we(r){let t=document.querySelector(".tracks");t&&(t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,V(g),Ge(),D(g),document.getElementById("prev-track").addEventListener("click",()=>{g=(g-1+8)%8,V(g),q(),D(g)}),document.getElementById("next-track").addEventListener("click",()=>{g=(g+1)%8,V(g),q(),D(g)}));let n=document.getElementById("bpm");n&&(n.value=ie(),n.addEventListener("input",()=>{Z(Number(n.value))})),window.addEventListener("keydown",e=>{try{let o=e.target;if(o&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable))return;let s=e.key;if(!/^[1-9]$/.test(s))return;let c=Number(s)-1;if(c<0||c>=8)return;let d=document.querySelector(".track-screen");g===c?d&&d.classList.toggle("collapsed"):(d&&d.classList.remove("collapsed"),g=c,V(g),D(g)),q()}catch(o){console.warn("Keyboard handler error",o)}})}var ee=null;async function We(){if(await ve(["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"]),Z(95),a&&a.length>0){a.forEach(e=>e.pattern.forEach(o=>o.trig=!1)),[0,3,7,10,12].forEach(e=>{a[0]&&a[0].pattern[e]&&(a[0].pattern[e].trig=!0)}),[4,12].forEach(e=>{a[1]&&a[1].pattern[e]&&(a[1].pattern[e].trig=!0)});for(let e=0;e<16;e+=2)a[2]&&a[2].pattern[e]&&(a[2].pattern[e].trig=!0);[6,14].forEach(e=>{a[3]&&a[3].pattern[e]&&(a[3].pattern[e].trig=!0)}),[4,12].forEach(e=>{a[4]&&a[4].pattern[e]&&(a[4].pattern[e].trig=!0)}),[2,6,11,15].forEach(e=>{a[5]&&a[5].pattern[e]&&(a[5].pattern[e].trig=!0)}),[8,14].forEach(e=>{a[6]&&a[6].pattern[e]&&(a[6].pattern[e].trig=!0)}),[7,13].forEach(e=>{a[7]&&a[7].pattern[e]&&(a[7].pattern[e].trig=!0)}),a[0]&&(a[0].volume=1),a[1]&&(a[1].volume=.9),a[2]&&(a[2].volume=.55),a[3]&&(a[3].volume=.5),a[4]&&(a[4].volume=.6),a[5]&&(a[5].volume=.6),a[6]&&(a[6].volume=.5),a[7]&&(a[7].volume=.45),a[0]&&(a[0].filterFreq=1800),a[1]&&(a[1].filterFreq=2200),a[2]&&(a[2].filterFreq=7e3)}we(()=>ee);let t=document.getElementById("play-btn"),n=document.getElementById("stop-btn");t&&t.addEventListener("click",async()=>{await he(),ee=v.currentTime,Ee(()=>ee)}),n&&n.addEventListener("click",()=>{ge(),ee=null,Te()}),_(),q(),console.log("App booted \u2014 press Play")}We().catch(r=>console.error("Boot failed:",r));
