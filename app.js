var J=["samples/kick1.wav","samples/snare.wav","samples/hat1.wav","samples/hat2.wav","samples/clap.wav","samples/perc1.wav","samples/perc2.wav","samples/perc3.wav"];var be=window.AudioContext||window.webkitAudioContext,f=new be,W=f.createGain();W.gain.setValueAtTime(1,f.currentTime);var D=f.createAnalyser();D.fftSize=2048;W.connect(D);D.connect(f.destination);var z=class{constructor(t,e,n=0){this.context=t,this.sampleUrl=e,this.index=n,this.buffer=null,this.pattern=new Array(16).fill(null).map(()=>({trig:!1,locks:{}})),this.volume=.8,this.filterFreq=2e3,this.filterType="lowpass",this.filterQ=1,this.gainNode=t.createGain(),this.gainNode.connect(W),this.level=1,this.gainNode.gain.setValueAtTime(this.level,this.context.currentTime),this.muted=!1,this.solo=!1}async load(){try{let t=await fetch(this.sampleUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);let e=await t.arrayBuffer();this.buffer=await this.context.decodeAudioData(e)}catch(t){console.warn(`Could not load sample "${this.sampleUrl}":`,t),this.buffer=null}}trigger(t,e={}){let n={volume:e.volume??this.volume,filterFreq:e.filterFreq??this.filterFreq,filterType:e.filterType??this.filterType,filterQ:e.filterQ??this.filterQ};if(this.buffer){let a=this.context.createBufferSource();a.buffer=this.buffer;let i=this.context.createBiquadFilter();i.type=n.filterType||"lowpass",i.frequency.value=n.filterFreq,typeof n.filterQ=="number"&&(i.Q.value=n.filterQ);let l=this.context.createGain();l.gain.setValueAtTime(0,t),l.gain.linearRampToValueAtTime(n.volume,t+.005),a.connect(i),i.connect(l),l.connect(this.gainNode),a.start(t)}else{let a=this.context.createOscillator(),i=200+this.index%8*60;a.type="square",a.frequency.setValueAtTime(i,t);let l=this.context.createBiquadFilter();l.type=n.filterType||"lowpass",l.frequency.setValueAtTime(n.filterFreq,t);try{typeof n.filterQ=="number"&&l.Q.setValueAtTime(n.filterQ,t)}catch(c){console.warn(`Filter Q setting failed: ${c.message}`)}let s=this.context.createGain();s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(n.volume,t+.02),s.gain.linearRampToValueAtTime(0,t+.18),a.connect(l),l.connect(s),s.connect(this.gainNode),a.start(t),a.stop(t+.2)}}},X=120;function Se(r=X){return 1/(r/60*4)}var Z=!1,O=0,V=0,xe=.1,o=[];function Ae(r,t){o.forEach(e=>{let n=e.pattern[r];if(n?.trig){try{if(typeof document<"u"){let a={trackIndex:e.index,step:r,time:t};document.dispatchEvent(new CustomEvent("track-trigger",{detail:a}))}}catch(a){console.log(`Exception while doing something: ${a.message}`)}e.trigger(t,n.locks)}})}function Y(){if(!Z)return;let r=f.currentTime;for(;V<r+xe;)Ae(O,V),V+=Se(),O=(O+1)%16;requestAnimationFrame(Y)}async function ee(){f.state==="suspended"&&await f.resume(),Z=!0,O=0,V=f.currentTime,Y()}function te(){Z=!1}async function ne(r){return o=r.map((t,e)=>new z(f,t,e)),await Promise.all(o.map(t=>t.load())),o}function B(){let r=o.some(e=>e.solo),t=f.currentTime;o.forEach(e=>{let a=(r?e.solo:!e.muted)?1:0;try{e.gainNode.gain.cancelScheduledValues(t),e.gainNode.gain.setValueAtTime(e.level*a,t)}catch(i){console.log(`Exception while doing something: ${i.message}`)}})}function re(){return D}function $(r){X=r}function j(){return X}var w=null,P=-1,d=0,Q=null,N=null,T=null,H=null,U=null,G=new Map;typeof document<"u"&&document.addEventListener("track-trigger",r=>{try{let t=r?.detail?.trackIndex;typeof t=="number"&&we(t)}catch{}});function ae(r){w&&cancelAnimationFrame(w);function t(){Le(r),w=requestAnimationFrame(t)}w=requestAnimationFrame(t),Me()}function oe(){w&&cancelAnimationFrame(w),w=null,document.querySelectorAll(".step--playhead").forEach(r=>r.classList.remove("step--playhead")),P=-1,ke()}function Ce(){if(N=document.getElementById("scope-canvas"),!N)return!1;let r=window.devicePixelRatio||1,t=N.getBoundingClientRect();if(N.width=Math.max(300,t.width*r),N.height=Math.max(120,t.height*r),T=N.getContext("2d"),T&&T.scale(r,r),H=re(),!H)return!1;let e=H.fftSize||2048;return U=new Uint8Array(e),!0}function ie(){if(!T||!H||!N||!U)return;let r=N.getBoundingClientRect(),t=r.width,e=r.height;H.getByteTimeDomainData(U),T.clearRect(0,0,t,e),T.fillStyle="rgba(0,0,0,0.02)",T.fillRect(0,0,t,e),T.lineWidth=2,T.strokeStyle="hsl(160 80% 60%)",T.beginPath();let n=U.length/t;for(let a=0;a<t;a++){let i=Math.floor(a*n),l=U[i]/128-1,s=e/2+l*(e/2)*.9;a===0?T.moveTo(a,s):T.lineTo(a,s)}T.stroke(),Q=requestAnimationFrame(ie)}function Me(){Q||Ce()&&ie()}function ke(){Q&&cancelAnimationFrame(Q),Q=null}function Le(r){let t=r();if(t===null)return;let e=f.currentTime-t,n=1/(j()/60*4);if(n<=0)return;let i=(Math.floor(e/n)%16+16)%16;if(i===P)return;let l=document.querySelector(".track-display");l&&(P>=0&&l.querySelectorAll(`.step[data-step="${P}"]`).forEach(s=>s.classList.remove("step--playhead")),l.querySelectorAll(`.step[data-step="${i}"]`).forEach(s=>s.classList.add("step--playhead")),P=i)}function R(r){let t=o[r],e=document.querySelector(".track-display"),n=document.getElementById("track-info");if(!e)return;P=-1,e.innerHTML="";let a=document.createElement("div");a.className="track",a.innerHTML=`
    <h2>Track ${r+1}</h2>
  `;let i=document.createElement("div");i.className="steps";let s=`hsl(${Math.round(r*360/Math.max(1,8))} 75% 48%)`;i.style.setProperty("--track-accent",s);for(let c=0;c<16;c++){let u=document.createElement("button");u.className="step",u.dataset.step=String(c),t.pattern[c]?.trig&&u.classList.add("active"),u.addEventListener("click",()=>{t.pattern[c].trig=!t.pattern[c].trig,u.classList.toggle("active",t.pattern[c].trig)}),i.appendChild(u)}if(a.appendChild(i),e.appendChild(a),n){let c=t.sampleUrl?t.sampleUrl.replace(/^.*\//,""):"\u2014";n.innerHTML="";let u=document.createElement("span");u.className="meta",u.textContent=`Track ${r+1}`;let h=document.createElement("span");h.textContent=`Sample: ${c}`,n.appendChild(u),n.appendChild(h)}}function Ne(){let r=document.getElementById("mixer");if(!r)return;r.innerHTML="";let t=document.createElement("div");t.className="track-info",t.innerHTML='<div class="meta">Mixer</div><div class="muted">Mute / Solo per track</div>',r.appendChild(t);let e=document.createElement("div");e.className="mixer-grid",o.forEach((n,a)=>{let i=document.createElement("div");i.className="channel",i.dataset.track=String(a);let s=`hsl(${Math.round(a*360/Math.max(1,8))} 75% 48%)`;i.style.setProperty("--channel-accent",s);let c=document.createElement("div");c.className="label",c.textContent=n.sampleUrl?n.sampleUrl.replace(/^.*\//,""):`Track ${a+1}`;let u=document.createElement("div");u.className="controls";let h=document.createElement("button");h.className="mute",h.title="Mute",h.textContent="M",h.addEventListener("click",b=>{b.stopPropagation(),n.muted=!n.muted,B(),M()});let E=document.createElement("button");E.className="solo",E.title="Solo",E.textContent="S",E.addEventListener("click",b=>{b.stopPropagation(),n.solo=!n.solo,B(),M()}),u.appendChild(h),u.appendChild(E);let F=document.createElement("div");F.className="fader-wrap";let g=document.createElement("input");g.type="range",g.min="0",g.max="1",g.step="0.01";let y=typeof n.level=="number"?n.level:n.gainNode?.gain?.value??1;g.value=String(y),g.title="Level",F.appendChild(g),g.addEventListener("input",()=>{let b=Number(g.value),A=f.currentTime;try{n.gainNode.gain.cancelScheduledValues(A),n.gainNode.gain.setValueAtTime(n.gainNode.gain.value,A);let q=o.some(x=>x.solo)?n.solo:!n.muted,_=b*(q?1:0);n.gainNode.gain.linearRampToValueAtTime(_,A+.03)}catch{try{n.gainNode.gain.setValueAtTime(b,A)}catch{}}n.level=b}),u.appendChild(F),i.appendChild(c),i.appendChild(u),i.addEventListener("click",b=>{let A=b.target;if(A&&(A.classList.contains("mute")||A.classList.contains("solo")))return;let S=document.querySelector(".track-screen");d===a&&S||(S&&S.classList.remove("collapsed"),d=a,R(d),I(d),M())}),e.appendChild(i)}),r.appendChild(e),M()}function we(r,t=160){let e=document.querySelector(`.mixer-grid .channel[data-track="${r}"]`);if(!e)return;let n=G.get(r);n&&(clearTimeout(n),G.delete(r)),e.classList.add("channel--hit");let a=setTimeout(()=>{e.classList.remove("channel--hit"),G.delete(r)},t);G.set(r,a)}function I(r){let t=document.getElementById("filter");if(!t)return;let e=o[r];t.innerHTML="";let n=20,a=2e4,i=.1,l=30,s=document.createElement("h3");s.textContent=`Filter \u2014 Track ${r+1}`,t.appendChild(s);let c=document.createElement("div");c.className="filter-note",c.textContent=e.sampleUrl?e.sampleUrl.replace(/^.*\//,""):"\u2014",t.appendChild(c);let u=[["lowpass","LP"],["highpass","HP"],["bandpass","BP"],["notch","NT"],["allpass","AP"],["peaking","PK"]],h=document.createElement("div");h.className="filter-type-row",u.forEach(([m,v])=>{let p=document.createElement("button");p.className="filter-type-btn",p.type="button",p.textContent=v,e.filterType===m&&p.classList.add("active"),p.addEventListener("click",()=>{e.filterType=m,h.querySelectorAll(".filter-type-btn").forEach(k=>k.classList.toggle("active",k===p))}),h.appendChild(p)}),t.appendChild(h);let E=document.createElement("div");E.className="filter-row";let F=document.createElement("span");F.textContent="Freq";let g=document.createElement("span");g.className="filter-value",g.textContent=`${Math.round(e.filterFreq||2e3)}Hz`;let y=document.createElement("input");y.type="range",y.min="0",y.max="1000",y.step="1";let b=m=>{let v=Math.log10(n),p=Math.log10(a);return(Math.log10(m)-v)/(p-v)*1e3},A=m=>{let v=Math.log10(n),p=Math.log10(a),k=m/1e3;return 10**(v+k*(p-v))};y.value=String(b(e.filterFreq||2e3)),y.className="control",y.addEventListener("input",()=>{let m=A(Number(y.value));e.filterFreq=m,g.textContent=`${Math.round(m)}Hz`}),E.appendChild(F),E.appendChild(g),E.appendChild(y),t.appendChild(E);let S=document.createElement("div");S.className="filter-row";let q=document.createElement("span");q.textContent="Res";let _=document.createElement("span");_.className="filter-value",_.textContent=(e.filterQ||1).toFixed(2);let x=document.createElement("input");x.type="range",x.min="0",x.max="1000",x.step="1";let se=m=>{let v=Math.log10(i),p=Math.log10(l);return(Math.log10(m)-v)/(p-v)*1e3},ce=m=>{let v=Math.log10(i),p=Math.log10(l),k=m/1e3;return 10**(v+k*(p-v))};x.value=String(se(e.filterQ||1)),x.className="control",x.addEventListener("input",()=>{let m=ce(Number(x.value));e.filterQ=m,_.textContent=m.toFixed(2)}),S.appendChild(q),S.appendChild(_),S.appendChild(x),t.appendChild(S)}function M(){let r=document.querySelector(".mixer-grid");r&&r.querySelectorAll(".channel").forEach(t=>{let n=Number(t.dataset.track),a=o[n],i=t.querySelector(".mute"),l=t.querySelector(".solo");i&&i.classList.toggle("active",!!a.muted),l&&l.classList.toggle("active",!!a.solo);let s=t.querySelector(".fader-wrap input");if(s){let c=typeof a.level=="number"?a.level:a.gainNode?.gain?.value??1;s.value=String(c)}t.classList.toggle("active",n===d)})}function le(r){let t=document.querySelector(".tracks");if(t){t.innerHTML=`
      <div class="sequencer-controls">
        <button id="prev-track" class="nav-btn" aria-label="Previous track">\u25C0</button>
        <div class="track-screen">
          <div id="track-info" class="track-info"></div>
          <section class="track-display"></section>
        </div>
        <button id="next-track" class="nav-btn" aria-label="Next track">\u25B6</button>
      </div>
    `,R(d),Ne(),I(d);let n=document.getElementById("prev-track"),a=document.getElementById("next-track");n&&n.addEventListener("click",()=>{d=(d-1+8)%8,R(d),M(),I(d)}),a&&a.addEventListener("click",()=>{d=(d+1)%8,R(d),M(),I(d)})}let e=document.getElementById("bpm");e&&(e.value=String(j()),e.addEventListener("input",()=>{$(Number(e.value))})),window.addEventListener("keydown",n=>{try{let a=n.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.isContentEditable))return;let i=n.key;if(!/^[1-9]$/.test(i))return;let l=Number(i)-1;if(l<0||l>=8)return;let s=document.querySelector(".track-screen");if(d===l){if(s)return}else s&&s.classList.remove("collapsed"),d=l,R(d),I(d);M()}catch(a){console.warn("Keyboard handler error",a)}})}var K=null;async function qe(){if(await ne([...J]),$(120),o&&o.length>0){for(let e of o)for(let n of e.pattern)n.trig=!1;[0,3,7,10,12].forEach(e=>{o[0]?.pattern[e]&&(o[0].pattern[e].trig=!0)}),[4,12].forEach(e=>{o[1]?.pattern[e]&&(o[1].pattern[e].trig=!0)});for(let e=0;e<16;e+=2)o[2]?.pattern[e]&&(o[2].pattern[e].trig=!0);[6,14].forEach(e=>{o[3]?.pattern[e]&&(o[3].pattern[e].trig=!0)}),[4,12].forEach(e=>{o[4]?.pattern[e]&&(o[4].pattern[e].trig=!0)}),[2,6,11,15].forEach(e=>{o[5]?.pattern[e]&&(o[5].pattern[e].trig=!0)}),[8,14].forEach(e=>{o[6]?.pattern[e]&&(o[6].pattern[e].trig=!0)}),[7,13].forEach(e=>{o[7]?.pattern[e]&&(o[7].pattern[e].trig=!0)}),o[0]&&(o[0].volume=1),o[1]&&(o[1].volume=.9),o[2]&&(o[2].volume=.55),o[3]&&(o[3].volume=.5),o[4]&&(o[4].volume=.6),o[5]&&(o[5].volume=.6),o[6]&&(o[6].volume=.5),o[7]&&(o[7].volume=.45),o[0]&&(o[0].filterFreq=1800),o[1]&&(o[1].filterFreq=2200),o[2]&&(o[2].filterFreq=7e3)}le(()=>K);let r=document.getElementById("play-btn"),t=document.getElementById("stop-btn");r&&r.addEventListener("click",async()=>{await ee(),K=f.currentTime,ae(()=>K)}),t&&t.addEventListener("click",()=>{te(),K=null,oe()}),B(),M(),console.log("App booted \u2014 press Play")}qe().catch(r=>console.error("Boot failed:",r));
